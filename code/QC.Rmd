---
title: | 
  | Section: 
  | Ovarian Proteomics: QC on the proteomics data
output:
  bookdown::html_document2:
    theme: journal
    highlight: kate
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
    code_folding: hide
    css: "style.css"
date: "`r format(Sys.time(), '%d %B, %Y')`"    
bibliography: references.bib 
editor_options: 
  chunk_output_type: console
---

```{r knitr, include=FALSE}
# knitr
knitr::opts_chunk$set(echo = TRUE, 
                      collapse = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      cache = FALSE, 
                      cache.path = "../cache/", 
                      fig.height = 5, 
                      fig.width = 6,
                      eval=TRUE)
```

# Purpose 
The main aim of the analyses is to QC the protein data and identify any outlier samples and batch effects


## Issues to discuss


 - Missing values
 - Normalization 
 - Variables to regress, time, death, ???

 

# QC of data

```{r setup1, echo=FALSE ,include=FALSE}
# import libraries and data
#renv::init()
library(tidyverse)
library(reshape2)
library(magrittr)
library(readxl)
library(fuzzyjoin)
library(limma)
library(DBI)
library(VIM)
library(factoextra)
library(FactoMineR)
library(mice)
library(SummarizedExperiment)
#renv::install("stemangiola/tidySummarizedExperiment")
library(xlsx)
library(tidySummarizedExperiment)

library(RColorBrewer)
library(GGally)
library(ggiraphExtra)
library(knitr)
library(kableExtra)
library(plotly)
library(RankAggreg)
library(DT)
library(ggVennDiagram)
getwd()

source("./code/functions.R")
```


```{r setup1, echo=FALSE ,include=FALSE}
data <- list()
data$raw_data <- read_excel( "./data/rawdata/Ovarian_cancer_data.xlsx", sheet = 1   ) |> as_matrix()

#rownames(data$raw_data) <- data$raw_data$Protein.Group

data$sample_prep <-  read_excel( "./data/rawdata/Ovarian_cancer_data.xlsx", sheet = 2   ) %>% 
                    set_rownames(.$Sample_ID) |>  
                    as.data.frame()

data$sample_clin <-  read_excel( "./data/rawdata/Ovarian_cancer_data.xlsx", sheet = 3   ) 

## Remove the duplicated rows

data$sample_clin <- data$sample_clin |> distinct(Sample_ID, .keep_all = TRUE)


data$row_data <-  read_excel( "./data/rawdata/Ovarian_cancer_data.xlsx", 
                              sheet = 4   ) %>% 
                              set_rownames(.$Protein.Group) |> 
                              as.data.frame()

## join sample prep sheets

data$coldata <- merge(data$sample_prep, data$sample_clin, 
                      by.x =  "Sample_ID", 
                      by.y= "Sample_ID", 
                      all.x=  TRUE, 
                      all.y=FALSE) %>% 
                set_rownames(.$Sample_ID) 

View(data$coldata)

data$raw_data_mat <- as.matrix(data$raw_data[, data$coldata$Sample_ID] |> as.data.frame())
colnames(data$raw_data_mat) <- data$coldata$Sample_ID
rownames(data$raw_data_mat) <- data$raw_data$Protein.Group
#dimnames(data$raw_data_mat) <- list(data$raw_data$Protein.Group, data$coldata$Sample_ID)

sumExpObj<- SummarizedExperiment(assays = list(raw_data = data$raw_data),
    colData= data$coldata,
    rowData= data$row_data
)
```


```{r setup1, echo=FALSE ,include=FALSE}

sumExpObj_tidy <- sumExpObj |> tidy()
sumExpObj_tidy

saveRDS(sumExpObj, "./data/sumExpObj.rds") # raw data with sample and row annotations as SummarizedExperiment
saveRDS(sumExpObj_tidy, "./data/sumExpObj_tidy.rds") # tidy version
```


## Analyze missingness{.tabset}

First samples with missing values greater than 50% were removed from the study
 - Overall data set and analyses 
 - Filter proteins in more than 75% samples and the median log intensity below 18
 - analyses with pehnotype variables
 
Due to samples prepared and run at different time-points, the samples were divided into sample processing batches

 - Filter proteins in more than 75% samples and the median log intensity below 18 in each batch.
 - Analyse protein relationship with phenotype data.

### Overall data set 

```{r}
sumExpObj <- readRDS("./data/sumExpObj.rds") #lo
sumExpObj_tidy <- readRDS("./data/sumExpObj_tidy.rds")

png("./results/figures/QC/missingSamples.png", res = 300, width = 8000, height = 3000)
mice_sample <- aggr(assays(sumExpObj)$raw_data, col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj$screening_number, cex.axis=.4,
 gap=2, ylab=c("Missing data","Pattern"))
dev.off()

sumExpObj$nmissing <- mice_sample$missings$Count
sumExpObj$percent_missing <- (mice_sample$missings$Count/dim(sumExpObj)[1])*100
sumExpObj_filt

sumExpObj_filt <- sumExpObj[ ,sumExpObj$percent_missing < 60]
sumExpObj_filt <- sumExpObj_filt[, !duplicated(sumExpObj_filt$Sample_ID2) ]
sumExpObj_filt <- sumExpObj_filt[, -(which(sumExpObj_filt$Sample_ID2 %in% c("PoolDIA_1", "BBkas")))]
sumExpObj_filt <- sumExpObj_filt[,!(sumExpObj_filt$Sample_ID2=="PoolDIA")]

png("./results/figures/QC/missingSamples_filt.png", res = 300, width = 8000, height = 3000)
mice_sample <- aggr(assays(sumExpObj_filt)$raw_data, col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj$screening_number, cex.axis=.4,
 gap=2, ylab=c("Missing data","Pattern"))
dev.off()

png("./results/figures/QC/missingProt.png", res = 300, width = 12000, height = 8000)
mice_prot <- aggr(t(assays(sumExpObj_filt)$raw_data), col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj$screening_number, cex.axis=1,
 gap=1, ylab=c("Missing data","Pattern"))
dev.off()

mice_prot$missings$Count %>% hist(breaks=200)

rowData(sumExpObj_filt)$nmissing <- mice_prot$missings$Count
rowData(sumExpObj_filt)$percent_missing <- (mice_prot$missings$Count/dim(sumExpObj_filt)[1])*100
rowData(sumExpObj_filt)$prot_means <- assays(sumExpObj_filt)$raw_data |> log2() |> rowMeans(na.rm = TRUE)
rowData(sumExpObj_filt)$prot_median <- assays(sumExpObj_filt)$raw_data |> log2() |> rowMedians(na.rm = TRUE)

png("./results/figures/QC/missingProt_vs_median.png", res = 300, width = 1600, height = 1400)
ggplot2::ggplot(rowData(sumExpObj_filt) |> as.data.frame(), aes(prot_median, percent_missing )) + geom_point()
dev.off()

png("./results/figures/QC/missingProt_vs_means.png", res = 300, width = 1600, height = 1400)
ggplot2::ggplot(rowData(sumExpObj_filt) |> as.data.frame(), aes(prot_means, percent_missing ), ) + geom_point()
dev.off()
```

## Filter based on missing prtein intensity values

We filter out values that have missing values in more that 25% of the sample if the median value is below 20.

```{r}

sumExpObj_overall <- sumExpObj_filt[rowData(sumExpObj_filt)$percent_missing < 25 & rowData(sumExpObj_filt)$prot_median > 18 , ]

png("./results/figures/QC/missingPro_overall_filt.png", res = 300, width = 12000, height = 8000)
mice_prot <- aggr(t(assays(sumExpObj_overall)$raw_data), col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj_overall$screening_number, cex.axis=1,
 gap=1, ylab=c("Missing data","Pattern"))
dev.off()

assays(sumExpObj_overall)$log2 <- log2(assays(sumExpObj_overall)$raw_data)
assays(sumExpObj_overall)$loess <-limma::normalizeCyclicLoess(assays(sumExpObj_overall)$log2, iterations = 5) # Normalize using Loess on log2 trnasformed data
assays(sumExpObj_overall)$vsn <- limma::normalizeVSN(log2(assays(sumExpObj_overall)$raw_data))

sumExpObj_overall <- sumExpObj_overall[, !is.na(sumExpObj_overall$Type_1_2) | !is.na(sumExpObj_overall$tumor_type) ]
sumExpObj_overall$tumor_type[grep("Other", sumExpObj_overall$tumor_type)] <- "Other"
sumExpObj_overall$tumor_type <- as.factor(sumExpObj_overall$tumor_type) |> relevel(ref = "H")
sumExpObj_overall$Type_1_2 <- as.factor(sumExpObj_overall$Type_1_2) |> relevel(ref = "0")


saveRDS(sumExpObj_overall, "./data/sumExpObj_overall.rds")

```




```{r}
sumExpObj_overall <- readRDS( "../data/sumExpObj_overall.rds")
limma::plotDensities(assays(sumExpObj_overall)$loess , sumExpObj_filt$Sample_prep_batch)
limma::plotDensities(assays(sumExpObj_overall)$vsn , sumExpObj_overall$Batch_Ash_2)
```

> The density plost after normalizations using loess and vsn indicated a batch effect between summer and winter samples.
> For the first round of analyses, the summer, summer_2 and winter samples were first analysesed independently and then compared with the 
> staitics from the full data set.

# Statistical ananlyses: Overall data set

### Tumor type

```{r}
rowData(sumExpObj_overall)$rowVars <- rowVars(assays(sumExpObj_overall)$loess, na.rm = TRUE)

sumExpObj_overall_filt <- sumExpObj_overall[rowData(sumExpObj_overall)$rowVars > 0.5 & rowData(sumExpObj_overall)$rowVars < 3, ]
   
#design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_overall_filt))

design_tt <- model.matrix(~ 0 + tumor_type, data = colData(sumExpObj_overall_filt))

name <- levels(sumExpObj_overall_filt$tumor_type)
colnames(design_tt) <- name

fit_tt <- lmFit((assays(sumExpObj_overall_filt)$loess), design = design_tt)
contrast.matrix <- makeContrasts(B-H, BL-H, M-H, BL-B, M-B, levels=name)
fit_tt <- contrasts.fit(fit_tt, contrast.matrix)
fit_tt <- eBayes(fit = fit_tt)


Results_overall <- list()

Results_overall$Bnign_vs_Healthy <- topTable(fit_tt, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$BL_vs_H <- topTable(fit_tt, p.value = 1, number = Inf, coef = "BL - H" , confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  )  

Results_overall$BL_vs_B <- topTable(fit_tt, p.value = 1, number = Inf, coef = "BL - B" , confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  )  

Results_overall$Malignant_vs_Healthy <- topTable(fit_tt, p.value = 1, number = Inf, coef = "M - H" , confint = TRUE)  %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$Malignant_vs_Benign <- topTable(fit_tt, p.value = 1, number = Inf, coef = "M - B" , confint = TRUE)  %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 


```

### Type_1_2 variable

```{r}
design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_overall_filt))

name <- levels(sumExpObj_overall_filt$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt)$loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


#Results_overall <- list()

Results_overall$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 
Results_overall$data <- assays(sumExpObj_overall_filt)$no_batch_loess %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 


writexl::write_xlsx(Results_overall, "./results/result_files/DE_results_overall_dataset.xlsx")

```


# Batch effect removal and analysses 

## Sample preparation batch

### Type_1_2 variable

```{r}

assays(sumExpObj_overall_filt)$no_batch_loess <- removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_t12)

name <- levels(sumExpObj_overall_filt$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


Results_overall_b <- list()

Results_overall_b$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

```

### Tumor type Variable

```{r}
design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(sumExpObj_overall_filt))

name_b <-  levels(sumExpObj_overall_filt$tumor_type)

colnames(design_tt_b) <- name_b

# assays(sumExpObj_overall_filt)$test2 <-removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_tt_b)

fit_tt_b <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess), design = design_tt_b)
contrast.matrix_b <- makeContrasts(B-H, BL-H, M-H , BL-B, M-B, M-BL, levels=name_b)
fit_tt_b <- contrasts.fit(fit_tt_b, contrast.matrix_b)

  


fit_tt_b <- eBayes(fit = fit_tt_b)




Results_overall_b$Bnign_vs_H <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_H <-  topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_B <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - B", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_BL <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - BL", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$data <- assays(sumExpObj_overall_filt)$no_batch_loess %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 



writexl::write_xlsx(Results_overall_b, "./results/result_files/DE_results_overall_dataset_SamplePrep_batch_removed.xlsx")


```


## Season batch

### Type_1_2 variable

```{r}

assays(sumExpObj_overall_filt)$no_batch_loess_season <- removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Batch_Ash_2, design = design_t12)

name <- levels(sumExpObj_overall_filt$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess_season), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


Results_overall_b_s <- list()

Results_overall_b_s$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

```

### Tumor type Variable

```{r}
design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(sumExpObj_overall_filt))

name_b <-  levels(sumExpObj_overall_filt$tumor_type)

colnames(design_tt_b) <- name_b

# assays(sumExpObj_overall_filt)$test2 <-removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_tt_b)

fit_tt_b <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess_season), design = design_tt_b)
contrast.matrix_b <- makeContrasts(B-H, BL-H, M-H , BL-B, M-B, M-BL, levels=name_b)
fit_tt_b <- contrasts.fit(fit_tt_b, contrast.matrix_b)

  


fit_tt_b <- eBayes(fit = fit_tt_b)




Results_overall_b_s$Bnign_vs_H <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$Malignant_vs_H <-  topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$Malignant_vs_B <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - B", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$Malignant_vs_BL <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - BL", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$data <- assays(sumExpObj_overall_filt)$no_batch_loess_season %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) 


 writexl::write_xlsx(Results_overall_b_s, 
  "./results/result_files/DE_results_overall_dataset_Season_batch_removed.xlsx")


```



# Batchwise analyses and meta analyses 

## Analyses in Summer, autumn and winter batches

## Analyses in Sample preparation batches


```{r}
sumExpObj_overall$Type_1_2_new <- case_when(
  sumExpObj_overall$Type_1_2 ==0 ~ "zero",
  sumExpObj_overall$Type_1_2 ==1 ~ "one",
    sumExpObj_overall$Type_1_2 ==2 ~ "two"                                    
                                        )
sumExpObj_overall$Type_1_2_new <- as.factor(sumExpObj_overall$Type_1_2_new)
sumExpObj_overall$Type_1_2_new <- relevel(sumExpObj_overall$Type_1_2_new, ref="zero")
batches <- unique(sumExpObj_overall$Batch_Ash_2)
season_batches <- list()

for  (i in 1:length(batches)){
  
  season_batches[[batches[i]]] <- sumExpObj_overall[, sumExpObj_overall$Batch_Ash_2 == batches[i]] # subset each batch
  
  png(paste0("./results/figures/QC/", batches[i], "_missingProt.png"), res = 300, width = 12000, height = 8000)
  mice_prot <- aggr(t(assays(season_batches[[batches[i]]])$raw_data), col=c('navyblue','yellow'),
  numbers=TRUE, sortVars=TRUE,
  labels=season_batches[[batches[i]]]$screening_number, cex.axis=1,
  gap=1, ylab=c("Missing data","Pattern"))
  dev.off()

  ## Create data for missing values
  rowData(season_batches[[batches[i]]])$nmissing <- mice_prot$missings$Count
  
  rowData(season_batches[[batches[i]]])$percent_missing <- (mice_prot$missings$Count/dim(season_batches[[batches[i]]])[2])*100

  
  season_batches[[batches[i]]] <-  season_batches[[batches[i]]][rowData(season_batches[[batches[i]]])$percent_missing < 25,]
  
  
  rowData(season_batches[[batches[i]]])$prot_means <- assays(season_batches[[batches[i]]])$raw_data |> log2() |> rowMeans(na.rm = TRUE)
  
  rowData(season_batches[[batches[i]]])$prot_median <- assays(season_batches[[batches[i]]])$raw_data |> log2() |> rowMedians(na.rm = TRUE)
  
  
  assays(season_batches[[batches[i]]])$log2 <- log2(assays(season_batches[[batches[i]]])[["raw_data"]])
  assays(season_batches[[batches[i]]])$loess_batch <- limma::normalizeCyclicLoess(assays(season_batches[[batches[i]]])[["log2"]], iterations = 5)
 
  # assays(season_batches[[batches[i]]])$vsn_batch <- limma::normalizeVSN(assays(season_batches[[batches[i]]])[["log2"]])
  
  png(paste0("./results/figures/QC/Desities_raw_",batches[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(assays(season_batches[[batches[i]]])[["log2"]], season_batches[[batches[i]]]$Batch)
  dev.off()
 
  png(paste0("./results/figures/QC/Desities_loess_batch_",batches[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(assays(season_batches[[batches[i]]])[["loess_batch"]], season_batches[[batches[i]]]$Batch)
  dev.off() 
  
  #  png(paste0("./results/figures/QC/Desities_vsn_batch_",batches[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  # limma::plotDensities(assays(season_batches[[batches[i]]])[["vsn_batch"]], season_batches[[batches[i]]]$Batch)
  # dev.off() 
  
  
   rowData(season_batches[[batches[i]]])$row_vars <- assays(season_batches[[batches[i]]])$loess_batch |> rowVars(na.rm = TRUE)

   season_batches[[batches[i]]] <-  season_batches[[batches[i]]][rowData(season_batches[[batches[i]]])$row_vars > 0.5 & rowData(season_batches[[batches[i]]])$row_vars < 3,]
  
}

common_prot <- Reduce(intersect, lapply(season_batches, rownames))
season_batches_f <- lapply(season_batches , function(x) x[common_prot,] )
```


## Differeential abundancee analyses 

```{r}
for  (i in 1:length(batches)){
  
  data <- season_batches[[batches[i]]]
  design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(data))

design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(data))

name <- levels(data$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(data)$loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


Results_overall_b <- list()

Results_overall_b$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 
Results_overall_b$data <- assays(data)$batch_loess %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 



#######



### Tumor type 
design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(data))

name_b <-  levels(data$tumor_type)

colnames(design_tt_b) <- name_b

# assays(sumExpObj_overall_filt)$test2 <-removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_tt_b)

fit_tt_b <- lmFit((assays(data)$loess_batch), design = design_tt_b)
contrast.matrix_b <- makeContrasts(B-H, BL-H, M-H , BL-B, M-B, M-BL, levels=name_b)
fit_tt_b <- contrasts.fit(fit_tt_b, contrast.matrix_b)

  


fit_tt_b <- eBayes(fit = fit_tt_b)




Results_overall_b$Bnign_vs_H <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_H <-  topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_B <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - B", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_BL <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - BL", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$data <- assays(data)$loess_batch %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 



writexl::write_xlsx(Results_overall_b, paste0("./results/result_files/DE_results_" , batches[i], ".xlsx"))

  
}
  
```


## Perform meta analysees


```{r}
loess_batches <- lapply(season_batches_f, function(x) (assays(x))$loess_batch)
loess_lables <- lapply(season_batches_f, colnames)
outcome_ttype <- lapply(season_batches_f, function(x) (colData(x)$Type_1_2_new))

outcome_ttype_df <- lapply(outcome_ttype, function(x) {data.frame(x)} )
for (k in 1:length(outcome_ttype_df)){
   colnames(outcome_ttype_df[[k]]) <- "label"
}

select.group <- c('zero','one')
ref.level <- "zero"
data.type <- "continuous"
ind.method <- rep('limma',length(outcome_ttype))
resp.type <- "twoclass"
paired <- rep(FALSE,length(outcome_ttype))
meta.method <- "Fisher"
#REM.type <- "RML"
meta.res <- MetaDE(data=loess_batches,clin.data = outcome_ttype_df,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    paired=paired,tail='abs',parametric=TRUE)

meta_results <- list()
meta_results$Type_1_vs_0 <- MetaDE::summary.meta(meta.res, resp.type = resp.type, meta.method = meta.method) %>% as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) %>% arrange(FDR)


select.group <- c("one","two")
ref.level <- "one"
data.type <- "continuous"
ind.method <- rep('limma',length(outcome_ttype))
resp.type <- "twoclass"
paired <- rep(FALSE,length(outcome_ttype))
meta.method <- "Fisher"
#REM.type <- "RML"
meta.res2 <- MetaDE(data=loess_batches,clin.data = outcome_ttype_df,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    paired=paired,tail='abs',parametric=TRUE )

meta_results$Type_2_vs_1 <- MetaDE::summary.meta(meta.res2, resp.type = resp.type, meta.method = meta.method) %>% as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) %>% arrange(FDR)

View(meta.res.summary_02)

select.group <- c("zero","two")
ref.level <- "zero"
data.type <- "continuous"
ind.method <- rep('limma',length(outcome_ttype))
resp.type <- "twoclass"
paired <- rep(FALSE,length(outcome_ttype))
meta.method <- "Fisher"
#REM.type <- "RML"
meta.res3 <- MetaDE(data=loess_batches,clin.data = outcome_ttype_df,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    paired=paired,tail='abs',parametric=TRUE )

meta_results$Type_2_vs_0 <- MetaDE::summary.meta(meta.res3, resp.type = resp.type, meta.method = "Fisher")  %>% as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) %>% arrange(FDR)

writexl::write_xlsx(meta_results, 
  "./results/result_files/Meta_analyses_results.xlsx")

```

```{r}
heatmap.sig.genes(result = meta.res, meta.method = "Fisher",fdr.cut = 0.2,color="GR")
```


```{r}
outcome_t_1_2 <- lapply(season_batches, function(x) (colData(x)$Type_1_2))

Results_Type_1_2_batch <- list()
Results_tumor_type_batch <- list()

```



```{r}
design_type <- Type_1_2
  
#tumor_type <- as.factor(season_batches[[batches[i]]]$tumor_type) |> relevel(ref = "H")
#design_test <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_filt))

design_tt <- model.matrix(~ 0 + data_all_tt$tumor_type, data = colData(season_batches[[batches[i]]]))
name <- levels(season_batches[[batches[i]]]$tumor_type)
colnames(design_tt) <- name

fit_tt <- lmFit((assays(data_all_tt)$loess), design = design_tt)
contrast.matrix <- makeContrasts(B-H, BL-H, M-H, BL-B, M-B, levels=name)
fit2 <- contrasts.fit(fit_tt, contrast.matrix)
fit_tt <- eBayes(fit = fit_tt)
Results$Bnign <- topTable(fit_tt, p.value = 1, number = Inf, coef = "B")
Results$Bnign_local <- topTable(fit_tt, p.value = 1, number = Inf, coef = "BL")
Results$Malignant <- topTable(fit_tt, p.value = 1, number = Inf, coef = "Malignant")

  
}
```


```{r}
renv::restore("../renv 2.lock")
```


### PCA analyses

Principle component analyses was used to perform exploratory analyses of the proteomics data. Explained variance by each principle component was calculated using the output from prcomp´ function in R. Correlation between principle components and phenotype (clinical) variables was calculated using ´lm´ function in R and "adj.r.squared" values were extracted from the summary statistics produced by the ´lm´ function.

```{r, eval = FALSE,include=FALSE,  echo = FALSE, fig.width=10, fig.height=18, warning = FALSE, message= FALSE}

pcaobjl <- stats::prcomp(t(log2(na.omit(assays(sumExpObj_filt)$loess))), )

percentVarl <- round(pcaobjl$sdev^2 / sum(pcaobjl$sdev^2),2)*100

pcamatl1 <- as.data.frame(pcaobjl$x[,1:20])
colData(sumExpObj_filt) <- merge(as.data.frame(colData(sumExpObj_filt)), pcamatl1 , by = 0) %>% set_rownames(.$Sample_ID) |> DataFrame()
saveRDS(sumExpObj_filt, "./data/data_sumExpfil.rds")

```

### Plot sample overview using PCA

```{r eval=FALSE, include=FALSE}
plot.pca1 <- ggplot(as.data.frame(colData(sumExpObj_filt)), aes(PC1, PC3, color = Sample_prep_batch)) + 
  geom_point(size=2, alpha = 0.9) + 
  #scale_colour_brewer(palette = "Set2") + 
  xlab(paste("PC1: ", percentVarl[1], "% variance", sep="")) + 
  ylab(paste("PC2: ", percentVarl[2], "% variance", sep="")) + 
  theme_bw() + 
    geom_text(
     label=sumExpObj_filt$Sample_prep_batch, 
  #   #nudge_x = 0.25, nudge_y = 0.25, 
  #   check_overlap = T
   ) + 
  ggtitle("PCA color indicating the batch and lable indicating the time-point") +
  theme(legend.title = element_blank())
plot.pca1

ggplotly(plot.pca1)

ggsave(plot.pca1,
  file = paste("./results/figures/QC/",
    "PCA_batch_season", ".png",
    sep = ""
  ),
  scale = 2,
  units = "cm", height = 10, width = 15
)
```


---------------------





Remove the pool samples and duplicated patient IDs.

```{r}
seasons <- unique(sumExpObj_filt$Batch_Ash_2)


season_batches <- list()

for  (i in 1:length(seasons)){
  season_batches[[seasons[i]]] <- sumExpObj_filt_2[, sumExpObj_filt_2$Batch_Ash_2 == seasons[i]]
  assays(season_batches[[seasons[i]]])$loess_batch <- limma::normalizeCyclicLoess(log2(assays(season_batches[[seasons[i]]])[["raw_data"]]), iterations = 5)
  assays(season_batches[[seasons[i]]])$vsn_batch <- limma::normalizeVSN(log2(assays(season_batches[[seasons[i]]])[["raw_data"]]))
  
  png(paste0("./results/figures/QC/Desities_raw_f",seasons[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(log2(assays(season_batches[[seasons[i]]])[["raw_data"]]), season_batches[[seasons[i]]]$Batch)
  dev.off()
 
  png(paste0("./results/figures/QC/Desities_loess_batch_f",seasons[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(assays(season_batches[[seasons[i]]])[["loess_batch"]], season_batches[[seasons[i]]]$Batch)
  dev.off() 
  
   png(paste0("./results/figures/QC/Desities_vsn_batch_f",seasons[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(assays(season_batches[[seasons[i]]])[["vsn_batch"]], season_batches[[seasons[i]]]$Batch)
  dev.off() 
  
}
```






## Cluster samples
```{r}

```

********Fix this

```{r  eval=FALSE, include=FALSE, echo = FALSE, fig.width=20, fig.height=18, warning = FALSE, message= FALSE}
distsl <- dist(t(assays(sumExpObj_filt)$loess))

hc <-hclust(distsl)
labs <- colnames(sumExpObj_filt)
dendr    <- ggdendro::dendro_data(hc, type="rectangle") # convert for ggplot
clust    <- cutree(hc,k=4)    # find 4 clusters

clust.df <- data.frame(label=names(clust), cluster=factor(clust))
# dendr[["labels"]] has the labels, merge with clust.df based on label column
dendr[["labels"]] <- merge(dendr[["labels"]],clust.df, by="label")
# plot the dendrogram; note use of color=cluster in geom_text(...)
ggplot() + 
  geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
  geom_text(data=label(dendr), aes(x, y, label=label, hjust=0, color=cluster), 
           size=3) +
  coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
  theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank())

ggdendro::ggdendrogram(hc)
```

## Explained variance by PCs

This step calculates explained variance by each principle component of the protein data.

```{r eval=FALSE, include=FALSE}
png("./results/figures/QC/PC_VariancePlot.png", units = "cm", height = 24, width = 20, res = 300)
barplot(percentVarl[1:10] , ylab = "Percent varinace explained", xlab = "PC 1 to 10", main = "Percent variace explained by first 10 PCs (loess)", col = "purple")
dev.off()
```

## Correlation of principle component with Phenotype data

To identify the most relevant clinical variables associated with protein data, we calculate correlation between the principle components and the phenotype variables.

```{r eval=FALSE, include=FALSE}

#clin_vars <- c("Batch", "Age_dignosis", "CA125_preop", "tumor_type", "Type", "Histology_PAD" , "FIGO_2014" ,  "Type_1_2" , "FIGO_stage", "Endometrios_at_op", "Endometrios_prior_op" , "Neo_recidiv_staging_op")

clin_vars <- c("Batch", "Batch_Ash_2", "Age_dignosis",  "tumor_type", "Type",  "Type_1_2" , "Endometrios_at_op", "Endometrios_prior_op")

tech_var <- c("Batch" , "Clinic ID", "Run_date"   , "Sampling_date" , "Op.date" , "nmissing" , )


pheno <- colData(sumExpObj_filt)[ ,clin_vars]
pcs <- colData(sumExpObj_filt)[, grep("PC", colnames(colData(sumExpObj_filt)))[1:10]]

pc_adj_rsq_l <- matrix(NA, ncol = 10, nrow = dim(pheno)[2])

for (i in 1:dim(pheno)[2]) {
  pc_adj_rsq_l[i, ] <- apply(pcs, 2, function(x) summary(lm(x ~ pheno[, i]))$adj.r.squared)
}
colnames(pc_adj_rsq_l) <- colnames(pcs)
rownames(pc_adj_rsq_l) <- colnames(pheno)


png("./results/figures/QC/PC_phen_updated.png", units = "cm", height = 24, width = 20, res = 300)
pheatmap::pheatmap(pc_adj_rsq_l, display_numbers = TRUE, fontsize = 12, cluster_cols = FALSE, main = "Adj R^2 of Association between PCs and clinical  and technical variables")
dev.off()
```

## PCA using VSN normalization

```{r}
res.pca_vsn <- PCA(t(assays(sumExpObj_filt)$vsn),  graph = TRUE)
```

```{r}
exp_var_vsn <- fviz_screeplot(res.pca_vsn, addlabels = TRUE, ylim = c(0, 12))
ggsave(exp_var_vsn,
  file = paste("../",
    "explained_var_vsn", ".png",
    sep = ""
  ),
  scale = 2,
  units = "cm", height = 10, width = 15
)
```


```{r, eval = FALSE,include=FALSE,  echo = FALSE, fig.width=10, fig.height=18, warning = FALSE, message= FALSE}
is.na(assays(Data_se_comp)$imputed) %>% sum()

pcaobjl_vsn <- stats::prcomp(t(na.omit(assays(sumExpObj_filt)$vsn)), )

percentVarl_vsn <- round(pcaobjl_vsn$sdev^2 / sum(pcaobjl_vsn$sdev^2),2)*100

pcamatl1_vsn <- as.data.frame(pcaobjl_vsn$x)
pcamatl2_vsn <- as.data.frame(merge(pcamatl1_vsn, colData(sumExpObj_filt), by = 0))
pcamatl2_vsn
```

### Plot sample overview using PCA

```{r eval=FALSE, include=FALSE}
plot.pca1_vsn <- ggplot(pcamatl2_vsn, aes(PC1, PC2, color = Batch, text = Row.names)) + 
  geom_point(size=2, alpha = 0.9) + 
  scale_colour_brewer(palette = "Set2") + 
  xlab(paste("PC1: ", percentVarl_vsn[1], "% variance", sep="")) + 
  ylab(paste("PC2: ", percentVarl_vsn[2], "% variance", sep="")) + 
  theme_bw() + 
   geom_text(
    label=pcamatl2$time, 
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T
  ) + 
  ggtitle("PCA color indicating the batch and lable indicating the time-point") +
  theme(legend.title = element_blank())

#ggplotly(plot.pca12)

ggsave(plot.pca1_vsn,
  file = paste("../",
    "PCA_batch_time_vsn", ".png",
    sep = ""
  ),
  scale = 2,
  units = "cm", height = 10, width = 15
)


plot.pca12_vsn <- ggplot(pcamatl2_vsn, aes(PC1, PC2, color = Batch, text = Row.names)) + 
  geom_point(size=2, alpha = 0.9) + 
  scale_colour_brewer(palette = "Set2") + 
  xlab(paste("PC1: ", percentVarl_vsn[1], "% variance", sep="")) + 
  ylab(paste("PC2: ", percentVarl_vsn[2], "% variance", sep="")) + 
  theme_bw() + 
  geom_text(
    label=pcamatl2_vsn$randomisation_code, 
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T
  ) +
  ggtitle("PCA color indicating the batch and lable indicating the temperature group") +
  theme(legend.title = element_blank())
plot.pca12  
ggsave(plot.pca12_vsn,
  file = paste("../",
    "PCA_batch_rand_code_vsn", ".png",
    sep = ""
  ),
  scale = 2,
  units = "cm", height = 10, width = 15
)
```





## Correlation of principle component with Phenotype data

To identify the most relevant clinical variables associated with protein data, we calculate correlation between the principle components and the phenotype variables.

```{r eval=FALSE, include=FALSE}

pheno <- pcamatl2_vsn[ ,clin_vars]

pc_adj_rsq_l_vsn <- matrix(NA, ncol = 10, nrow = dim(pheno)[2])

for (i in 1:dim(pheno)[2]) {
  pc_adj_rsq_l_vsn[i, ] <- apply(pcamatl2_vsn[, 2:11], 2, function(x) summary(lm(x ~ pheno[, i]))$adj.r.squared)
}
colnames(pc_adj_rsq_l_vsn) <- colnames(pcamatl2_vsn[, 2:11])
rownames(pc_adj_rsq_l_vsn) <- colnames(pheno)


png("../corrPlot_updated_vsn.png", units = "cm", height = 24, width = 20, res = 300)
pheatmap::pheatmap(pc_adj_rsq_l_vsn, display_numbers = TRUE, fontsize = 12, cluster_cols = FALSE, main = "Adj R^2 of Association between PCs and clinical  and technical variables")
dev.off()
```

## Save the filtered data and PCs

```{r}
colData(sumExpObj_filt) <- merge(colData(sumExpObj_filt), pcamatl1[, 1:15], by = 0)
saveRDS(sumExpObj_filt, "../normalized_filtered_se.rds")
```




-------------------------------

```{r setup2, echo=TRUE ,include=TRUE}

# Get Quantities of PG.ProteinGroups
nn_sp_report_l <- melt(data = nn_sp_report, id.vars = "PG.ProteinGroups", measure.vars = na.omit(str_match(colnames(nn_sp_report), '.*?PG.Quantity'))[,1], variable.name = 'sample')

# table of missing values count
nn_missing <- nn_sp_report_l %>% distinct(`PG.ProteinGroups`,sample,value) %>% group_by(sample) %>% mutate(sum_na = sum(is.nan(value))) %>% ungroup() %>% 
  group_by(`PG.ProteinGroups`) %>% mutate(sum_na_prot = sum(is.nan(value))) %>% mutate(sum_pep = length(`PG.ProteinGroups`)) %>% dplyr::select(`PG.ProteinGroups`,sample,sum_na, sum_na_prot, sum_pep)

# CK imputation method
max.impute.value <- nn_sp_report_l %>%
    group_by(`PG.ProteinGroups`) %>%
    summarise(min_int = min(value, na.rm = T)) %>%
    mutate(max_imp = 0.5*min_int)
nn_sp_report_l <- nn_sp_report_l %>%
    left_join(max.impute.value) %>%
    dplyr::rowwise() %>%
    mutate(Imputed = if_else(is.nan(value),TRUE, FALSE)) %>%
    mutate(value = if_else(is.nan(value), runif(1,min = 0.005*max_imp, max = max_imp), value))

# log2 of value (intensity)
nn_sp_report_l <- nn_sp_report_l %>% mutate(log2_val = log2(value))   

# Calculate protein groups quantitative intensity (quant_int) and also log10, select unique protein - sample relation  
nn_sp_report_l <- nn_sp_report_l %>% group_by(`PG.ProteinGroups`, sample) %>% mutate(quant_int = mean(value), quant_int_log10 = log10(quant_int)) %>% ungroup() %>% distinct(`PG.ProteinGroups`,sample,quant_int,quant_int_log10,Imputed)

# Normalize by subtraction of mean 
nn_sp_report_l <- nn_sp_report_l %>% group_by(sample) %>% mutate(scale_log10 = scale(quant_int_log10))

# Add timepoint column by splitting the sample identifier
nn_sp_report_l <- dplyr::rowwise(nn_sp_report_l) %>% mutate("time" = str_match(sample, "-[0-9]{2}-"), 
                                                            "sample" =  str_split(str_split(sample, ".htrms.")[[1]][1], " ")[[1]][2]) 
# Get total count of proteins (1 protein count per protein group)
total_pro <- nn_sp_report_l %>% dplyr::select(`PG.ProteinGroups`) %>% ungroup() %>% distinct(`PG.ProteinGroups`) %>% add_count(., name = "proteins")

# Make new table for peptide and protein counts
total_all <- cbind(total_pro[1,"proteins"])
colnames(total_all) <- c('proteins')
ta <- melt(data = total_all, measure.vars = colnames(total_all), variable.name = "id")



```


```{r setup3, echo=TRUE}
# Use RSQLite to count proteins
db <- dbConnect(RSQLite::SQLite(),"")
dbWriteTable(db,"nn_sp", nn_sp_report_l)
dbListTables(db)
nn_sp_report_counted <- dbGetQuery(db, 'SELECT `PG.ProteinGroups`,nn_sp.sample,quant_int,quant_int_log10,scale_log10,time,protein_count,Imputed FROM nn_sp LEFT JOIN(SELECT sample,count(Imputed) AS protein_count FROM nn_sp WHERE Imputed == 0 GROUP BY sample) AS pt ON pt.sample = nn_sp.sample')

dbDisconnect(db)

```

Run normalizeVSN from limma:
```{r normalizeVSN, echo=TRUE}
db <- dbConnect(RSQLite::SQLite(),"")
df_w <- dcast(nn_sp_report_l, `PG.ProteinGroups` ~ sample,value.var = "scale_log10")
rownames(df_w) <- df_w[,1]

df_imp <- dcast(nn_sp_report_l, `PG.ProteinGroups` ~ sample,value.var = "Imputed")
rownames(df_imp) <- df_imp[,1]
df_w[which(df_imp==TRUE)]

df_w <- as.matrix(df_w[,-1])
df_imp <- as.matrix(df_imp[,-1])
df_w_norm <- limma::normalizeVSN(df_w[,-1])
df_l_norm <- melt(data = df_w_norm, id.vars = rownames(df_w_norm), measure.vars = colnames(df_w_norm), variable.name = "sample" )
df_l_norm <- df_l_norm %>% rename("norm_log10" = "value")
nn_sp_report_counted <- left_join(nn_sp_report_counted, df_l_norm, by = c("PG.ProteinGroups"="Var1","sample"="Var2"))

```
Choose Random samples for plotting:
```{r sample_samples, echo=TRUE}
result_table <- nn_sp_report_counted
# distributions of sample of samples
samples <- result_table %>% distinct(sample) %>% as.list()
s = sample(samples$sample, 16)

```


```{r subsets_samples, echo=TRUE} 
# function for breaking down samples in subsets 
subset_samples <- function(sample_list, step){
  count <- 0
  subset_list <- list()
  for (i in seq(1,length(sample_list), by=step)){
    count <- count + 1
    subset_list[[count]] <- sample_list[i:(i+step-1)]
    
    }
return(subset_list)
}

# distributions of sample of samples
samples <- result_table %>% distinct(sample) %>% as.list()
s = sample(samples$sample, 16)
subset_list <- subset_samples(samples$sample, 16)
```


Write dataset output:
```{r write_output, echo=TRUE}
write_tsv(nn_sp_report_counted,"/home/rstudio/data/01_quality_check_table_directDIA.tsv" )

```


Plot total counts and counts by sample:
```{r total_counts, echo=TRUE, fig.height=6, fig.width=8}
# Plot total counts
title <- "Total counts"
total_count  <- ggplot(ta %>% 
                         rename("count" = "value","proteins" = "id"), 
                         aes(proteins,count)) +
  geom_bar(position = "dodge",stat = "identity") +
  theme(axis.text.x= element_text(angle = 90, vjust = 1, hjust=1 ,size = 8)) + 
  geom_text(aes(label = count), size = 4, color = "white", vjust= 1.5) +
  ggtitle(paste0(title)) 
(total_count)

# protein count by sample
title <- "Protein intensity by count"
plt_prot_dot_z <- ggplot(result_table %>% 
                        group_by(sample) %>% 
                        mutate(mean_quant_int = mean(quant_int)), 
                        aes(protein_count, mean_quant_int, colour = time)) +
                        geom_point() +
  theme(axis.text.x= element_text(angle = 0, vjust = 1, hjust=0.5 ,size = 10)) + 
  ggtitle(paste0(title)) 
(plt_prot_dot_z)

```

Boxplots to visualize sample variation before and after normalization:  
```{r plot2, echo=TRUE,  fig.height=6, fig.width=8}

# Boxplot before normalization 
title <- "Before normalization: Box plot of log10"
plt_box <- ggplot(result_table %>% filter(sample %in% s), aes(sample, quant_int_log10, fill = time)) +
  geom_boxplot() +
  theme(axis.text.x= element_text(angle = 90, vjust = 1, hjust=1 ,size = 7)) +
  ggtitle(paste0(title)) 
plot(plt_box)

# Boxplot after normalization 
title <- "After normalization: Box plot of log10"
plt_box <- ggplot(result_table %>% filter(sample %in% s), aes(sample, scale_log10, fill = time)) +
  geom_boxplot() +
  theme(axis.text.x= element_text(angle = 90, vjust = 1, hjust=1 ,size = 7)) + 
  ggtitle(paste0(title)) 
plot(plt_box)

 

```

Histograms to see how imputation affects distribution: 
```{r plot4, echo=TRUE, fig.height=6, fig.width=8}

  title <- "Without imputation: log10 protein intensities"
  plt_hist <- ggplot(result_table %>% filter(sample %in% s, Imputed == FALSE), aes(x = scale_log10)) +
    geom_histogram(bins = 60) +
    facet_wrap(~ sample) +
    ggtitle(paste0(title))
  plot(plt_hist)

  title <- "With imputation: log10 protein intensities"
  plt_hist <- ggplot(result_table %>% filter(sample %in% s), aes(x = scale_log10, fill = as.factor(Imputed))) +
    geom_histogram(bins = 60) +
     
    facet_wrap(~ sample) +
    ggtitle(paste0(title))
  plot(plt_hist)


```
QQ-plots to see how imputed values affect normal distribution:

```{r plot5, echo=TRUE, fig.height=6, fig.width=8}


  # qq-plots of sample of samples 
  title <- "Before imputation: QQ-plot of samples"
  plt_qq <- ggplot(result_table %>% filter(sample %in% s, Imputed == FALSE),aes( sample = scale_log10,  ), na.rm = T) +
    geom_qq() +
    facet_wrap(~ sample) +
    ggtitle(paste0(title))
  plot(plt_qq)

  title <- "After imputation : QQ-plot of samples"
  plt_qq <- ggplot(result_table %>% filter(sample %in% s),aes( sample = scale_log10  ), na.rm = T) +
    geom_qq() +
    facet_wrap(~ sample) +
    ggtitle(paste0(title))
  plot(plt_qq)


``` 



## PCA

```{r}
library()
library("FactoMineR")

res.pca <- PCA(t(log2(assays(sumExpObj_filt)$raw_data)),  graph = TRUE)
```


```{r}
fviz_screeplot(res.pca, addlabels = TRUE, ylim = c(0, 50))
```


