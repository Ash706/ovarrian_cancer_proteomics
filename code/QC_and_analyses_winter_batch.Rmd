---
title: | 
  | Section: 
  | Ovarian Proteomics: QC on the proteomics data
output:
  bookdown::html_document2:
    theme: journal
    highlight: kate
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
    code_folding: hide
    css: "style.css"
date: "`r format(Sys.time(), '%d %B, %Y')`"    
bibliography: references.bib 
editor_options: 
  chunk_output_type: console
---

```{r knitr, include=FALSE}
# knitr
knitr::opts_chunk$set(echo = TRUE, 
                      collapse = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      cache = FALSE, 
                      cache.path = "../cache/", 
                      fig.height = 5, 
                      fig.width = 6,
                      eval=TRUE)
```

# Purpose 

The main aim of the analyses is to QC the protein data and identify any outlier samples and batch effects


# QC of data

```{r setup1, echo=FALSE ,include=FALSE}
# import libraries and data
#renv::init()
library(tidyverse)
library(reshape2)
library(magrittr)
library(readxl)
library(fuzzyjoin)
library(Hmisc)
library(limma)
library(DBI)
library(VIM)
library(factoextra)
library(FactoMineR)
library(mice)
library(SummarizedExperiment)
#renv::install("stemangiola/tidySummarizedExperiment")
library(xlsx)
#library(tidySummarizedExperiment)

library(RColorBrewer)
library(GGally)
library(ggiraphExtra)
library(knitr)
library(kableExtra)
library(plotly)
library(RankAggreg)
library(DT)
library(ggVennDiagram)
getwd()

source("./code/functions.R")
```


```{r setup1, echo=FALSE ,include=FALSE}
data <- list()
data$raw_data <- read_excel( "./data/rawdata/Files for comparison_WinterBatch_SmallOvCa/220331_WinterbatchReanalysis_PRMATRIX_CleanedSheet.xlsx", sheet = 2, skip = 2) 

data$small_batch <- read_excel( "./data/rawdata/Files for comparison_WinterBatch_SmallOvCa/220331_OvCa_Smallbatch_SM_MJ_DIANNoutput.xlsx", sheet = 1   ) |> as_matrix()
#rownames(data$raw_data) <- data$raw_data$Protein.Group
## Deal with duplicated samples
##
dups <- c("BB47...2" ,  "BB47...3","BB826...167"  ,  "BB826...168"  , "BB928...179" ,   "BB928...180", "BB1057...218", "BB1057...219" )

log2(data$raw_data[, dups]) |> colSums(na.rm = TRUE) |> barplot() ## The second sample has more intensity and was kept

exclude <- c("BB47...2", "BB826...167", "BB928...179" , "BB1057...218")
oldnames <- c("BB47...3", "BB826...168", "BB928...180" , "BB1057...219")
newnames <- c("BB47", "BB826", "BB928" , "BB1057")
data$raw_data <- select(data$raw_data,  -all_of(exclude))

data$raw_data <- data$raw_data %>% rename_with(~ newnames, all_of(oldnames))

## Columns data 
data$sample_prep <-  read_excel( "./data/rawdata/Ovarian_cancer_data.xlsx", sheet = 2   ) %>% 
                    set_rownames(.$Sample_ID) |>  
                    as.data.frame()

data$sample_clin <-  read_excel( "./data/rawdata/Files for comparison_WinterBatch_SmallOvCa/220331_WinterbatchReanalysis_PRMATRIX_CleanedSheet.xlsx", sheet = 4   ) 

## Remove the duplicated rows

data$sample_clin <- data$sample_clin |> distinct(Sample_ID, .keep_all = TRUE)


data$row_data <-  read_excel( "./data/rawdata/Files for comparison_WinterBatch_SmallOvCa/220331_WinterbatchReanalysis_PRMATRIX_CleanedSheet.xlsx", 
                              sheet = 5   ) %>% 
                              set_rownames(.$Protein.Group) |> 
                              as.data.frame()

## join sample prep sheets

data$coldata <- merge(data$sample_prep, data$sample_clin, 
                      by.x =  "Sample_ID", 
                      by.y= "Sample_ID", 
                      all.x=  FALSE, 
                      all.y=FALSE) %>% 
                set_rownames(.$Sample_ID) 

View(data$coldata)

data$raw_data_mat_2 <- data$data_mat[, data$coldata$Sample_ID] 
colnames(data$raw_data_mat) <- data$coldata$Sample_ID
rownames(data$raw_data_mat) <- data$raw_data$Protein.Group
#dimnames(data$raw_data_mat) <- list(data$raw_data$Protein.Group, data$coldata$Sample_ID)

sumExpObj<- SummarizedExperiment(assays = list(raw_data = data$raw_data_mat),
    colData= data$coldata,
    rowData= data$row_data
)
```


```{r setup1, echo=FALSE ,include=FALSE}

# sumExpObj_tidy <- sumExpObj |> tidy()
# sumExpObj_tidy

saveRDS(sumExpObj, "./data/rawdata/sumExpObj_wnt.rds") # raw data with sample and row annotations as SummarizedExperiment
#saveRDS(sumExpObj_tidy, "./data/sumExpObj_tidy.rds") # tidy version
```


## Analyze missingness{.tabset}

First samples with missing values greater than 50% were removed from the study
 - Overall data set and analyses 
 - Filter proteins in more than 75% samples and the median log intensity below 18
 - analyses with pehnotype variables
 
Due to samples prepared and run at different time-points, the samples were divided into sample processing batches

 - Filter proteins in more than 75% samples and the median log intensity below 18 in each batch.
 - Analyse protein relationship with phenotype data.

### Overall data set 

```{r}
sumExpObj <- readRDS( "./data/rawdata/sumExpObj_wnt.rds") #lo
#sumExpObj_tidy <- readRDS("./data/sumExpObj_tidy.rds")

png("./results_wnt/figures/missingSamples.png", res = 300, width = 8000, height = 3000)
mice_sample <- VIM::aggr(assays(sumExpObj)$raw_data, col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj$screening_number, cex.axis=.4,
 gap=2, ylab=c("Missing data","Pattern"))
dev.off()

sumExpObj$nmissing <- mice_sample$missings$Count
sumExpObj$percent_missing <- (mice_sample$missings$Count/dim(sumExpObj)[1])*100
#sumExpObj_filt

sumExpObj_filt <- sumExpObj[ ,sumExpObj$percent_missing < 60]
#sumExpObj_filt <- sumExpObj_filt[, !duplicated(sumExpObj_filt$Sample_ID) ]
#sumExpObj_filt <- sumExpObj_filt[, -(which(sumExpObj_filt$Sample_ID2 %in% c("PoolDIA_1", "BBkas")))]
#sumExpObj_filt <- sumExpObj_filt[,!(sumExpObj_filt$Sample_ID2=="PoolDIA")]

png("./results_wnt/figures/missingSamples_filt.png", res = 300, width = 8000, height = 3000)
mice_sample <- VIM::aggr(assays(sumExpObj_filt)$raw_data, col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj_filt$screening_number, cex.axis=.4,
 gap=2, ylab=c("Missing data","Pattern"))
dev.off()

png("./results_wnt/figures/missingProt.png", res = 300, width = 12000, height = 8000)
mice_prot <- VIM::aggr(t(assays(sumExpObj_filt)$raw_data), col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj_filt$screening_number, cex.axis=1,
 gap=1, ylab=c("Missing data","Pattern"))
dev.off()

mice_prot$missings$Count %>% hist(breaks=200)

rowData(sumExpObj_filt)$nmissing <- mice_prot$missings$Count
rowData(sumExpObj_filt)$percent_missing <- (mice_prot$missings$Count/dim(sumExpObj_filt)[1])*100
rowData(sumExpObj_filt)$prot_means <- assays(sumExpObj_filt)$raw_data |> log2() |> rowMeans(na.rm = TRUE)
rowData(sumExpObj_filt)$prot_median <- assays(sumExpObj_filt)$raw_data |> log2() |> rowMedians(na.rm = TRUE)

png("./results_wnt/figures/missingProt_vs_median.png", res = 300, width = 1600, height = 1400)
ggplot2::ggplot(rowData(sumExpObj_filt) |> as.data.frame(), aes(prot_median, percent_missing )) + geom_point()
dev.off()

png("./results_wnt/figures/missingProt_vs_means.png", res = 300, width = 1600, height = 1400)
ggplot2::ggplot(rowData(sumExpObj_filt) |> as.data.frame(), aes(prot_means, percent_missing ), ) + geom_point()
dev.off()
```

## Filter based on missing prtein intensity values

We filter out values that have missing values in more that 25% of the sample if the median value is below 20.

```{r}
sumExpObj_overall <- sumExpObj_filt[rowData(sumExpObj_filt)$percent_missing < 30 & rowData(sumExpObj_filt)$prot_median > 20 , sumExpObj_filt$percent_missing < 40]

png("./results_wnt/figures/missingPro_overall_filt.png", res = 300, width = 12000, height = 8000)
mice_prot <- VIM::aggr(t(assays(sumExpObj_overall)$raw_data), col=c('navyblue','yellow'),
 numbers=TRUE, sortVars=TRUE,
 labels=sumExpObj_overall$screening_number, cex.axis=1,
 gap=1, ylab=c("Missing data","Pattern"))
dev.off()

rowData(sumExpObj_overall)$rowVars <- rowVars(log2(assays(sumExpObj_overall)$raw_data), na.rm = TRUE)

sumExpObj_overall_filt <- sumExpObj_overall[rowData(sumExpObj_overall)$rowVars > 0.25 , ]
```


## Normalize the data


```{r}
assays(sumExpObj_overall_filt)$log2 <- log2(assays(sumExpObj_overall_filt)$raw_data)
assays(sumExpObj_overall_filt)$loess <-limma::normalizeCyclicLoess(assays(sumExpObj_overall_filt)$log2, iterations = 5) # Normalize using Loess on log2 trnasformed data
#assays(sumExpObj_overall_filt)$vsn <- limma::normalizeVSN(log2(assays(sumExpObj_overall_filt)$raw_data))
assays(sumExpObj_overall_filt)$batch_rm_rwa <- limma::removeBatchEffect(assays(sumExpObj_overall_filt)$log2, batch = sumExpObj_overall_filt$Sample_prep_batch, batch2 = sumExpObj_overall_filt$Batch)
assays(sumExpObj_overall_filt)$batch_rm_loess <- limma::removeBatchEffect(assays(sumExpObj_overall_filt)$loess, batch = sumExpObj_overall_filt$Sample_prep_batch)
assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess <- limma::normalizeCyclicLoess(assays(sumExpObj_overall_filt)$batch_rm_rwa)



norm_imputed <- VIM::kNN(assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess, variable= colnames(assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess), imp_var= F, k = 5)
rownames(norm_imputed) <- rownames(sumExpObj_overall_filt)
assays(sumExpObj_overall_filt)$norm_imputed <- norm_imputed
```


## Density plots 


```{r}
plotDensities(assays(sumExpObj_overall_filt)$log2, group = sumExpObj_overall_filt$Type_1_2)
plotDensities(assays(sumExpObj_overall_filt)$loess,  group = sumExpObj_overall_filt$Type_1_2)
plotDensities(assays(sumExpObj_overall_filt)$batch_rm_rwa,  group = sumExpObj_overall_filt$Type_1_2)
plotDensities(assays(sumExpObj_overall_filt)$batch_rm_loess, group = sumExpObj_overall_filt$Type_1_2)
plotDensities(assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess, group = sumExpObj_overall_filt$Sample_prep_batch )
plotDensities(assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess, group = sumExpObj_overall_filt$Type_1_2 )
png("./results_wnt/figures/Densities_nomalized_updated_2.png", units = "cm", height = 24, width = 20, res = 300)
plotDensities(assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess, group = sumExpObj_overall_filt$Type_1_2 )
dev.off()
```

Filter >> remove_batch_effects >> normalize Cyclic Loess >> statistics

## PCA plots for QC

### PCA analyses {.tabset}

Principle component analyses was used to perform exploratory analyses of the proteomics data. Explained variance by each principle component was calculated using the output from prcomp´ function in R. Correlation between principle components and phenotype (clinical) variables was calculated using ´lm´ function in R and "adj.r.squared" values were extracted from the summary statistics produced by the ´lm´ function.

#### raw data

```{r, eval = FALSE,include=FALSE,  echo = FALSE, fig.width=10, fig.height=18, warning = FALSE, message= FALSE}

pca_raw <- stats::prcomp(t(na.omit(assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess)), )

percentVar_rw <- round(pca_raw$sdev^2 / sum(pca_raw$sdev^2),2)*100

pcamat_raw <- as.data.frame(pca_raw$x[,1:15])
colData(sumExpObj_overall_filt) <- merge(as.data.frame(colData(sumExpObj_overall_filt)), pcamat_raw , by = 0) %>% set_rownames(.$Sample_ID) |> DataFrame()
saveRDS(sumExpObj_overall_filt, "./data/data_sumExpfil_wnt.rds")

```

```{r eval=FALSE, include=FALSE}
plot.pca1 <- ggplot(as.data.frame(colData(sumExpObj_overall_filt)), aes(PC1, PC2, color= as.factor(Sample_prep_batch))) + 
  geom_point(size=2, alpha = 0.9) + 
  #Scale_colour_brewer(palette = "Set2") + 
  xlab(paste("PC1: ", percentVar_rw[1], "% variance", sep="")) + 
  ylab(paste("PC2: ", percentVar_rw[2], "% variance", sep="")) + 
  theme_bw() + 
    geom_text(
     label=sumExpObj_overall$Sample_prep_batch, 
  #   #nudge_x = 0.25, nudge_y = 0.25, 
  #   check_overlap = T
   ) + 
  ggtitle("PCA color indicating the batch and lable indicating the time-point") +
  theme(legend.title = element_blank())


plot.pca1

# ggplotly(plot.pca1)
# 
# ggsave(plot.pca1,
#   file = paste("./results/figures/QC/",
#     "PCA_batch_season_overall", ".png",
#     sep = ""
#   ),
#   scale = 2,
#   units = "cm", height = 10, width = 15
# )
```


## Explained variance by PCs

This step calculates explained variance by each principle component of the protein data.

```{r eval=FALSE, include=FALSE}
png("./results_wnt/figures/PC_VariancePlot.png", units = "cm", height = 24, width = 20, res = 300)
barplot(percentVar_rw[1:10] , ylab = "Percent varinace explained", xlab = "PC 1 to 10", main = "Percent variace explained by first 10 PCs (loess)", col = "purple")
dev.off()
```

## Correlation of principle component with Phenotype data

To identify the most relevant clinical variables associated with protein data, we calculate correlation between the principle components and the phenotype variables.

```{r eval=FALSE, include=FALSE}

#clin_vars <- c("Batch", "Age_dignosis", "CA125_preop", "tumor_type", "Type", "Histology_PAD" , "FIGO_2014" ,  "Type_1_2" , "FIGO_stage", "Endometrios_at_op", "Endometrios_prior_op" , "Neo_recidiv_staging_op")

clin_vars <- c("Batch",  "Sample_prep_batch", "Age_dignosis",  "tumor_type",  "Type_1_2")

tech_var <- c("Batch" , "Clinic ID", "Run_date"   , "Sampling_date" , "Op.date" , "nmissing" , )


pheno <- colData(sumExpObj_overall_filt)[ ,clin_vars]
pcs <- colData(sumExpObj_overall_filt)[, grep("PC", colnames(colData(sumExpObj_overall_filt)))[1:10]]

pc_adj_rsq_l <- matrix(NA, ncol = 10, nrow = dim(pheno)[2])

for (i in 1:dim(pheno)[2]) {
  pc_adj_rsq_l[i, ] <- apply(pcs, 2, function(x) summary(lm(x ~ pheno[, i]))$adj.r.squared)
}
colnames(pc_adj_rsq_l) <- colnames(pcs)
rownames(pc_adj_rsq_l) <- colnames(pheno)


png("./results_wnt/figures/PC_phen_updated_2.png", units = "cm", height = 12, width = 24, res = 200)
pheatmap::pheatmap(pc_adj_rsq_l, display_numbers = TRUE, fontsize = 12, cluster_cols = FALSE, main = "Adj R^2 of Association between PCs and clinical  and technical variables")
dev.off()
```



```{r}
sumExpObj_overall_filt <- sumExpObj_overall_filt[, !is.na(sumExpObj_overall_filt$Type_1_2) | !is.na(sumExpObj_overall_filt$tumor_type) ]
sumExpObj_overall_filt$tumor_type[grep("Other", sumExpObj_overall_filt$tumor_type)] <- "Other"
sumExpObj_overall_filt$tumor_type <- as.factor(sumExpObj_overall_filt$tumor_type) |> relevel(ref = "H")
sumExpObj_overall_filt$Type_1_2 <- as.factor(sumExpObj_overall_filt$Type_1_2) |> relevel(ref = "0")


saveRDS(sumExpObj_overall_filt, "./data/rawdata/sumExpObj_overall_wnt_filt.rds")

```



## Statistical analyses


> The density plost after normalizations using loess and vsn indicated a batch effect between summer and winter samples.
> For the first round of analyses, the summer, summer_2 and winter samples were first analysesed independently and then compared with the 
> staitics from the full data set.

# Statistical ananlyses: Overall data set

### Tumor type

```{r}

#design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_overall_filt))

design_tt <- model.matrix(~ 0 + tumor_type, data = colData(sumExpObj_overall_filt))

name <- levels(sumExpObj_overall_filt$tumor_type)
colnames(design_tt) <- name

fit_tt <- lmFit((assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess), design = design_tt)
contrast.matrix <- makeContrasts(B-H, BL-H, M-H, BL-B, M-B, levels=name)
fit_tt <- contrasts.fit(fit_tt, contrast.matrix)
fit_tt <- eBayes(fit = fit_tt)


Results_overall <- list()

Results_overall$Bnign_vs_Healthy <- topTable(fit_tt, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$BL_vs_H <- topTable(fit_tt, p.value = 1, number = Inf, coef = "BL - H" , confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  )  

Results_overall$BL_vs_B <- topTable(fit_tt, p.value = 1, number = Inf, coef = "BL - B" , confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  )  

Results_overall$Malignant_vs_Healthy <- topTable(fit_tt, p.value = 1, number = Inf, coef = "M - H" , confint = TRUE)  %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$Malignant_vs_Benign <- topTable(fit_tt, p.value = 1, number = Inf, coef = "M - B" , confint = TRUE)  %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 


```

### Type_1_2 variable

```{r}
design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_overall_filt))

name <- levels(sumExpObj_overall_filt$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


#Results_overall <- list()

Results_overall$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 
Results_overall$data <- assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  )
```


```{r}
writexl::write_xlsx(Results_overall, "./results_wnt/DE_results_overall_dataset_batchEff_removed_2.xlsx")

```

## Remove Other, and BL samples

```{r}
sumExpObj_overall_filt_rm_BL_Other <- sumExpObj_overall_filt[,sumExpObj_overall_filt$tumor_type |> as.character() %nin% c("Other", "BL")]
```



### Type_1_2 variable

```{r}
design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_overall_filt_rm_BL_Other))

name <- levels(sumExpObj_overall_filt_rm_BL_Other$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt_rm_BL_Other)$batch_rm_l_raw_loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


#Results_overall <- list()

Results_overall$type_one_vs_zero_filt <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$type_two_vs_zero_filt <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall$type_two_vs_one_filt <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 
# Results_overall$data <- assays(sumExpObj_overall_filt)$batch_rm_l_raw_loess %>%
#   as.data.frame() %>%
#   rownames_to_column(., var = "Protein.Group") %>%
# left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
#     {
#       .
#     },
#     by ="Protein.Group"
#   )
```

```{r}
writexl::write_xlsx(Results_overall, "./results_wnt/DE_results_overall_dataset_batchEff_removed_2.xlsx")

```


# Re-analyses with case control categories

```{r}
sumExpObj_overall <- readRDS( "./data/rawdata/sumExpObj_overall_wnt_filt.rds")

```

## Filter and prune outcome variable

Samples corresponding the "other" category were removed along with the samples with NA values in the outcome variable.

Based on the meeting with Karin in Spring, the outcome variable corresponding to tumor type were pruned as following.

For 0,1,2 coding, 1 and 2 were converted into one level.

For tumor type variable, "B" and "H" categories were not combined to form "Control" group while "BL" and "M" were combined to make the "case" category.


```{r}
sumExpObj_overall <- readRDS( "./data/rawdata/sumExpObj_overall_wnt_filt.rds")

sumExpObj_winter_overall_filt <- sumExpObj_overall[, !is.na(sumExpObj_overall$Type_1_2) | !is.na(sumExpObj_overall$tumor_type) ]
sumExpObj_winter_overall_filt$tumor_type[grep("Other", sumExpObj_winter_overall_filt$tumor_type)] <- "Other"
sumExpObj_winter_overall_filt <- sumExpObj_winter_overall_filt[ , which(sumExpObj_winter_overall_filt$tumor_type!="Other") ]

sumExpObj_winter_overall_filt$tumor_type_new <- case_when(
sumExpObj_winter_overall_filt$tumor_type =="B" |  sumExpObj_winter_overall_filt$tumor_type == "H" ~ "control",
  sumExpObj_winter_overall_filt$tumor_type =="BL" |  sumExpObj_winter_overall_filt$tumor_type == "M" ~ "case"
                                     
                                        )


sumExpObj_winter_overall_filt$tumor_type_new <- as.factor(sumExpObj_winter_overall_filt$tumor_type_new) |> relevel(ref = "control")

sumExpObj_winter_overall_filt$Type_1_2_new <- case_when(
sumExpObj_winter_overall_filt$Type_1_2 ==0 ~ "One",
  sumExpObj_winter_overall_filt$Type_1_2 ==1 |  sumExpObj_winter_overall_filt$Type_1_2 == 2 ~ "Two"
                                     
                                        )

sumExpObj_winter_overall_filt$Type_1_2_new  <- as.factor(sumExpObj_winter_overall_filt$Type_1_2_new ) |> relevel(ref = "One")


saveRDS(sumExpObj_winter_overall_filt, "./data/rawdata/data_sumExpfil_wntr_new_vars.rds")

```



## Statistical ananlyses: Overall data set for Loess Normalized data

### type

```{r}

#design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_summer_overall_filt))

design_tt <- model.matrix(~ 0 + tumor_type_new, data = colData(sumExpObj_winter_overall_filt))

name <- levels(sumExpObj_winter_overall_filt$tumor_type_new)
colnames(design_tt) <- name

fit_tt <- lmFit((assays(sumExpObj_winter_overall_filt)$batch_rm_l_raw_loess), design = design_tt)
contrast.matrix <- makeContrasts(case-control, levels=name)
fit_tt <- contrasts.fit(fit_tt, contrast.matrix)
fit_tt <- eBayes(fit = fit_tt)


Results_overall_wntr <- list()

Results_overall_wntr$case_vs_control <- topTable(fit_tt, p.value = 1, number = Inf, coef = "case - control", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_winter_overall_filt) |> as_tibble(),
    {
      .
    },
    by = "Protein.Group"
  ) 



```

### Tumor type variable

```{r}
design_tt2 <- model.matrix(~ 0 + Type_1_2_new, data = colData(sumExpObj_winter_overall_filt))

name <- levels(sumExpObj_winter_overall_filt$Type_1_2_new)
#name <- c("zero", "one", "two")
colnames(design_tt2) <- name

fit_12 <- lmFit((assays(sumExpObj_winter_overall_filt)$batch_rm_l_raw_loess), design = design_tt2)
contrast.matrix <- makeContrasts(Two-One, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


#Results_overall <- list()

Results_overall_wntr$type_two_vs_on <- topTable(fit_12, p.value = 1, number = Inf, coef = "Two - One", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_summer_overall_filt) |> as_tibble(),
    {
      .
    },
    
    by ="Protein.Group"
  )
```


```{r}
writexl::write_xlsx(Results_overall_wntr, "./results_wnt/DE_results_winter.xlsx")

```


__End__

_______________________
# Batch effect removal and analysses 

## Sample preparation batch

### Type_1_2 variable

```{r}

assays(sumExpObj_overall_filt)$no_batch_loess <- removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_t12)

name <- levels(sumExpObj_overall_filt$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


Results_overall_b <- list()

Results_overall_b$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

```

### Tumor type Variable

```{r}
design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(sumExpObj_overall_filt))

name_b <-  levels(sumExpObj_overall_filt$tumor_type)

colnames(design_tt_b) <- name_b

# assays(sumExpObj_overall_filt)$test2 <-removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_tt_b)

fit_tt_b <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess), design = design_tt_b)
contrast.matrix_b <- makeContrasts(B-H, BL-H, M-H , BL-B, M-B, M-BL, levels=name_b)
fit_tt_b <- contrasts.fit(fit_tt_b, contrast.matrix_b)

  


fit_tt_b <- eBayes(fit = fit_tt_b)




Results_overall_b$Bnign_vs_H <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_H <-  topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_B <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - B", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_BL <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - BL", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$data <- assays(sumExpObj_overall_filt)$no_batch_loess %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 



writexl::write_xlsx(Results_overall_b, "./results/result_files/DE_results_overall_dataset_SamplePrep_batch_removed.xlsx")

```



-----------------------------------
## Season batch

### Type_1_2 variable

```{r}

assays(sumExpObj_overall_filt)$no_batch_loess_season <- removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Batch_Ash_2, design = design_t12)

name <- levels(sumExpObj_overall_filt$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess_season), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


Results_overall_b_s <- list()

Results_overall_b_s$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

```

### Tumor type Variable

```{r}
design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(sumExpObj_overall_filt))

name_b <-  levels(sumExpObj_overall_filt$tumor_type)

colnames(design_tt_b) <- name_b

# assays(sumExpObj_overall_filt)$test2 <-removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_tt_b)

fit_tt_b <- lmFit((assays(sumExpObj_overall_filt)$no_batch_loess_season), design = design_tt_b)
contrast.matrix_b <- makeContrasts(B-H, BL-H, M-H , BL-B, M-B, M-BL, levels=name_b)
fit_tt_b <- contrasts.fit(fit_tt_b, contrast.matrix_b)

  


fit_tt_b <- eBayes(fit = fit_tt_b)




Results_overall_b_s$Bnign_vs_H <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$Malignant_vs_H <-  topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$Malignant_vs_B <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - B", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$Malignant_vs_BL <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - BL", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(sumExpObj_overall_filt) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b_s$data <- assays(sumExpObj_overall_filt)$no_batch_loess_season %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) 


 writexl::write_xlsx(Results_overall_b_s, 
  "./results/result_files/DE_results_overall_dataset_Season_batch_removed.xlsx")


```



# Batchwise analyses and meta analyses 

## Analyses in Summer, autumn and winter batches

## Analyses in Sample preparation batches


```{r}
sumExpObj_overall$Type_1_2_new <- case_when(
  sumExpObj_overall$Type_1_2 ==0 ~ "zero",
  sumExpObj_overall$Type_1_2 ==1 ~ "one",
    sumExpObj_overall$Type_1_2 ==2 ~ "two"                                    
                                        )
sumExpObj_overall$Type_1_2_new <- as.factor(sumExpObj_overall$Type_1_2_new)
sumExpObj_overall$Type_1_2_new <- relevel(sumExpObj_overall$Type_1_2_new, ref="zero")
batches <- unique(sumExpObj_overall$Batch_Ash_2)
season_batches <- list()

for  (i in 1:length(batches)){
  
  season_batches[[batches[i]]] <- sumExpObj_overall[, sumExpObj_overall$Batch_Ash_2 == batches[i]] # subset each batch
  
  png(paste0("./results/figures/QC/", batches[i], "_missingProt.png"), res = 300, width = 12000, height = 8000)
  mice_prot <- aggr(t(assays(season_batches[[batches[i]]])$raw_data), col=c('navyblue','yellow'),
  numbers=TRUE, sortVars=TRUE,
  labels=season_batches[[batches[i]]]$screening_number, cex.axis=1,
  gap=1, ylab=c("Missing data","Pattern"))
  dev.off()

  ## Create data for missing values
  rowData(season_batches[[batches[i]]])$nmissing <- mice_prot$missings$Count
  
  rowData(season_batches[[batches[i]]])$percent_missing <- (mice_prot$missings$Count/dim(season_batches[[batches[i]]])[2])*100

  
  season_batches[[batches[i]]] <-  season_batches[[batches[i]]][rowData(season_batches[[batches[i]]])$percent_missing < 25,]
  
  
  rowData(season_batches[[batches[i]]])$prot_means <- assays(season_batches[[batches[i]]])$raw_data |> log2() |> rowMeans(na.rm = TRUE)
  
  rowData(season_batches[[batches[i]]])$prot_median <- assays(season_batches[[batches[i]]])$raw_data |> log2() |> rowMedians(na.rm = TRUE)
  
  
  assays(season_batches[[batches[i]]])$log2 <- log2(assays(season_batches[[batches[i]]])[["raw_data"]])
  assays(season_batches[[batches[i]]])$loess_batch <- limma::normalizeCyclicLoess(assays(season_batches[[batches[i]]])[["log2"]], iterations = 5)
 
  # assays(season_batches[[batches[i]]])$vsn_batch <- limma::normalizeVSN(assays(season_batches[[batches[i]]])[["log2"]])
  
  png(paste0("./results/figures/QC/Desities_raw_",batches[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(assays(season_batches[[batches[i]]])[["log2"]], season_batches[[batches[i]]]$Batch)
  dev.off()
 
  png(paste0("./results/figures/QC/Desities_loess_batch_",batches[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  limma::plotDensities(assays(season_batches[[batches[i]]])[["loess_batch"]], season_batches[[batches[i]]]$Batch)
  dev.off() 
  
  #  png(paste0("./results/figures/QC/Desities_vsn_batch_",batches[i], ".png"), res = 300, units = "cm", height = 10, width = 15)
  # limma::plotDensities(assays(season_batches[[batches[i]]])[["vsn_batch"]], season_batches[[batches[i]]]$Batch)
  # dev.off() 
  
  
   rowData(season_batches[[batches[i]]])$row_vars <- assays(season_batches[[batches[i]]])$loess_batch |> rowVars(na.rm = TRUE)

   season_batches[[batches[i]]] <-  season_batches[[batches[i]]][rowData(season_batches[[batches[i]]])$row_vars > 0.5 & rowData(season_batches[[batches[i]]])$row_vars < 3,]
  
}

common_prot <- Reduce(intersect, lapply(season_batches, rownames))
season_batches_f <- lapply(season_batches , function(x) x[common_prot,] )
```


## Differeential abundancee analyses 

```{r}
for  (i in 1:length(batches)){
  
  data <- season_batches[[batches[i]]]
  design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(data))

design_t12 <- model.matrix(~ 0 + Type_1_2, data = colData(data))

name <- levels(data$Type_1_2)
name <- c("zero", "one", "two")
colnames(design_t12) <- name

fit_12 <- lmFit((assays(data)$loess), design = design_t12)
contrast.matrix <- makeContrasts(one-zero, two-zero, two-one, levels=name)
fit_12 <- contrasts.fit(fit_12, contrast.matrix)
fit_12 <- eBayes(fit = fit_12)


Results_overall_b <- list()

Results_overall_b$type_one_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "one - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_zero <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - zero", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$type_two_vs_one <- topTable(fit_12, p.value = 1, number = Inf, coef = "two - one", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 
Results_overall_b$data <- assays(data)$batch_loess %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 



#######



### Tumor type 
design_tt_b <- model.matrix(~ 0 + tumor_type, data = colData(data))

name_b <-  levels(data$tumor_type)

colnames(design_tt_b) <- name_b

# assays(sumExpObj_overall_filt)$test2 <-removeBatchEffect(assays(sumExpObj_overall_filt)$loess,  batch = sumExpObj_overall_filt$Sample_prep_batch, design = design_tt_b)

fit_tt_b <- lmFit((assays(data)$loess_batch), design = design_tt_b)
contrast.matrix_b <- makeContrasts(B-H, BL-H, M-H , BL-B, M-B, M-BL, levels=name_b)
fit_tt_b <- contrasts.fit(fit_tt_b, contrast.matrix_b)

  


fit_tt_b <- eBayes(fit = fit_tt_b)




Results_overall_b$Bnign_vs_H <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "B - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_H <-  topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - H", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_B <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - B", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$Malignant_vs_BL <- topTable(fit_tt_b, p.value = 1, number = Inf, coef = "M - BL", confint = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
 # arrange(padj) %>%
  left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 

Results_overall_b$data <- assays(data)$loess_batch %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(data) |> as_tibble(),
    {
      .
    },
    by ="Protein.Group"
  ) 



writexl::write_xlsx(Results_overall_b, paste0("./results/result_files/DE_results_" , batches[i], ".xlsx"))

  
}
  
```


## Perform meta analysees


```{r}
loess_batches <- lapply(season_batches_f, function(x) (assays(x))$loess_batch)
loess_lables <- lapply(season_batches_f, colnames)
outcome_ttype <- lapply(season_batches_f, function(x) (colData(x)$Type_1_2_new))

outcome_ttype_df <- lapply(outcome_ttype, function(x) {data.frame(x)} )
for (k in 1:length(outcome_ttype_df)){
   colnames(outcome_ttype_df[[k]]) <- "label"
}

select.group <- c('zero','one')
ref.level <- "zero"
data.type <- "continuous"
ind.method <- rep('limma',length(outcome_ttype))
resp.type <- "twoclass"
paired <- rep(FALSE,length(outcome_ttype))
meta.method <- "Fisher"
#REM.type <- "RML"
meta.res <- MetaDE(data=loess_batches,clin.data = outcome_ttype_df,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    paired=paired,tail='abs',parametric=TRUE)

meta_results <- list()
meta_results$Type_1_vs_0 <- MetaDE::summary.meta(meta.res, resp.type = resp.type, meta.method = meta.method) %>% as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) %>% arrange(FDR)


select.group <- c("one","two")
ref.level <- "one"
data.type <- "continuous"
ind.method <- rep('limma',length(outcome_ttype))
resp.type <- "twoclass"
paired <- rep(FALSE,length(outcome_ttype))
meta.method <- "Fisher"
#REM.type <- "RML"
meta.res2 <- MetaDE(data=loess_batches,clin.data = outcome_ttype_df,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    paired=paired,tail='abs',parametric=TRUE )

meta_results$Type_2_vs_1 <- MetaDE::summary.meta(meta.res2, resp.type = resp.type, meta.method = meta.method) %>% as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) %>% arrange(FDR)

View(meta.res.summary_02)

select.group <- c("zero","two")
ref.level <- "zero"
data.type <- "continuous"
ind.method <- rep('limma',length(outcome_ttype))
resp.type <- "twoclass"
paired <- rep(FALSE,length(outcome_ttype))
meta.method <- "Fisher"
#REM.type <- "RML"
meta.res3 <- MetaDE(data=loess_batches,clin.data = outcome_ttype_df,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    paired=paired,tail='abs',parametric=TRUE )

meta_results$Type_2_vs_0 <- MetaDE::summary.meta(meta.res3, resp.type = resp.type, meta.method = "Fisher")  %>% as.data.frame() %>%
  rownames_to_column(., var = "Protein.Group") %>%
left_join(rowData(sumExpObj_overall_filt) %>% 
            as_tibble(), 
  {
      .
    },
    by ="Protein.Group"
  ) %>% arrange(FDR)

writexl::write_xlsx(meta_results, 
  "./results/result_files/Meta_analyses_results.xlsx")

```

```{r}
heatmap.sig.genes(result = meta.res, meta.method = "Fisher",fdr.cut = 0.2,color="GR")
```


```{r}
outcome_t_1_2 <- lapply(season_batches, function(x) (colData(x)$Type_1_2))

Results_Type_1_2_batch <- list()
Results_tumor_type_batch <- list()

```



```{r}
design_type <- Type_1_2
  
#tumor_type <- as.factor(season_batches[[batches[i]]]$tumor_type) |> relevel(ref = "H")
#design_test <- model.matrix(~ 0 + Type_1_2, data = colData(sumExpObj_filt))

design_tt <- model.matrix(~ 0 + data_all_tt$tumor_type, data = colData(season_batches[[batches[i]]]))
name <- levels(season_batches[[batches[i]]]$tumor_type)
colnames(design_tt) <- name

fit_tt <- lmFit((assays(data_all_tt)$loess), design = design_tt)
contrast.matrix <- makeContrasts(B-H, BL-H, M-H, BL-B, M-B, levels=name)
fit2 <- contrasts.fit(fit_tt, contrast.matrix)
fit_tt <- eBayes(fit = fit_tt)
Results$Bnign <- topTable(fit_tt, p.value = 1, number = Inf, coef = "B")
Results$Bnign_local <- topTable(fit_tt, p.value = 1, number = Inf, coef = "BL")
Results$Malignant <- topTable(fit_tt, p.value = 1, number = Inf, coef = "Malignant")

  

```




---------------------



